<!DOCTYPE html>
<html>
  <head>
    <style>
      .container {
        display: flex;
      }
      #id_category_container {
        width: 200px;
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #e9e9e9;
        margin-right: 20px;
      }
      #id_chat_log_container {
        flex-grow: 1;
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
      }
      .message-input-container {
        font-size: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center; /* 센터 정렬을 위한 추가 스타일 */
      }
      .message-input-container input {
        flex-grow: 1;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <center>
      <h1>
        Hello, Welcome to my chat site! {% if request.user.is_authenticated %}
        {{ request.user.username }}{% else %}
        {{ request.session.anonymous_id|default:"Guest" }}{% endif %}
      </h1>
    </center>
    <br />
    <div class="container">
      <div id="id_category_container">
        <!-- 카테고리 목록 표시 -->
        {% for category in categories %}
        <button class="category-button" data-category-id="{{ category.id }}">
          {{ category.name }}
        </button>
        {% endfor %}
      </div>

      <div>
        <div id="id_chat_log_container">
          <!-- 로드된 메시지 표시 -->
          {% for message in messages %}
          <div>
            <strong>{{ message.username }}</strong>:
            <em>[{{ message.category.name }}]</em> {{ message.message }}
            <small>[{{ message.timestamp|date:"Y-m-d H:i:s" }}]</small>
          </div>
          {% endfor %}
        </div>
        <div class="message-input-container">
          <!--카테고리 선택 드롭 다운 -->
          <select id="id_category_select">
              <option value="">Select a category</option>
              {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
          </select>
          <!-- 메세지 입력 필드-->
          <input type="text" id="id_message_input" placeholder="Type a message..." />
          <!-- 메세지 전송 버튼 -->
          <button type="button" id="id_send_button">Send</button>
      </div>
    </div>

    <script>
      const chatSocket = new WebSocket(
        (window.location.protocol === "https:" ? "wss://" : "ws://") +
          window.location.host +
          "/ws/chat/"
      );
      let selectedCategoryId = null;

      function selectCategory(categoryId) {
        selectedCategoryId = categoryId;
      }

      document.querySelectorAll(".category-button").forEach((button) => {
        button.addEventListener("click", function () {
          selectedCategoryId = this.getAttribute("data-category-id");
          // 선택된 카테고리를 시각적으로 표시할 수 있습니다.
          document.querySelectorAll(".category-button").forEach((btn) => {
            btn.classList.remove("selected");
          });
          this.classList.add("selected"); // 선택된 스타일을 적용하기 위한 클래스 추가
        });
      });

      document.querySelector("#id_send_button").onclick = function () {
        const messageInput = document.querySelector("#id_message_input");
        const categorySelect = document.querySelector("#id_category_select");
        const message = messageInput.value.trim();
        const categoryId = categorySelect.value;

        if (message && categoryId) {
            chatSocket.send(JSON.stringify({
                message: message,
                categoryId: categoryId, // 선택된 카테고리 ID
            }));
            messageInput.value = "";
        } else {
            // 메시지나 카테고리가 선택되지 않았다면 경고를 표시합니다.
            alert("Please select a category and type a message.");
        }
    };

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        var messageDiv = document.createElement("div");
        messageDiv.innerHTML = `<strong>${data.username}</strong>: <em>[${
          data.category || "No Category"
        }]</em> ${data.message} <small>[${data.timestamp}]</small>`;
        document
          .querySelector("#id_chat_log_container")
          .appendChild(messageDiv);
        document.querySelector("#id_chat_log_container").scrollTop =
          document.querySelector("#id_chat_log_container").scrollHeight;
      };
    </script>
  </body>
</html>
